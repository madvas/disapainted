GIFEncoder=function(){function ByteArray(){this.bin=[]}for(var i=0,chr={};256>i;i++)chr[i]=String.fromCharCode(i);ByteArray.prototype.getData=function(){for(var v="",l=this.bin.length,i=0;l>i;i++)v+=chr[this.bin[i]];return v},ByteArray.prototype.writeByte=function(val){this.bin.push(val)},ByteArray.prototype.writeUTFBytes=function(string){for(var l=string.length,i=0;l>i;i++)this.writeByte(string.charCodeAt(i))},ByteArray.prototype.writeBytes=function(array,offset,length){for(var l=length||array.length,i=offset||0;l>i;i++)this.writeByte(array[i])};{var width,height,transIndex,out,image,pixels,indexedPixels,colorDepth,colorTab,exports={},transparent=null,repeat=-1,delay=0,started=!1,usedEntry=[],palSize=7,dispose=-1,closeStream=!1,firstFrame=!0,sizeSet=!1,sample=10,comment="Generated by jsgif (https://github.com/antimatter15/jsgif/)",reset=(exports.setDelay=function(ms){delay=Math.round(ms/10)},exports.setDispose=function(code){code>=0&&(dispose=code)},exports.setRepeat=function(iter){iter>=0&&(repeat=iter)},exports.setTransparent=function(c){transparent=c},exports.setComment=function(c){comment=c},exports.addFrame=function(im,is_imageData){if(null===im||!started||null===out)throw new Error("Please call start method before calling addFrame");var ok=!0;try{is_imageData?image=im:(image=im.getImageData(0,0,im.canvas.width,im.canvas.height).data,sizeSet||setSize(im.canvas.width,im.canvas.height)),getImagePixels(),analyzePixels(),firstFrame&&(writeLSD(),writePalette(),repeat>=0&&writeNetscapeExt()),writeGraphicCtrlExt(),""!==comment&&writeCommentExt(),writeImageDesc(),firstFrame||writePalette(),writePixels(),firstFrame=!1}catch(e){ok=!1}return ok},exports.finish=function(){if(!started)return!1;var ok=!0;started=!1;try{out.writeByte(59)}catch(e){ok=!1}return ok},function(){transIndex=0,image=null,pixels=null,indexedPixels=null,colorTab=null,closeStream=!1,firstFrame=!0}),setSize=(exports.setFrameRate=function(fps){15!=fps&&(delay=Math.round(100/fps))},exports.setQuality=function(quality){1>quality&&(quality=1),sample=quality},exports.setSize=function(w,h){(!started||firstFrame)&&(width=w,height=h,1>width&&(width=320),1>height&&(height=240),sizeSet=!0)}),analyzePixels=(exports.start=function(){reset();var ok=!0;closeStream=!1,out=new ByteArray;try{out.writeUTFBytes("GIF89a")}catch(e){ok=!1}return started=ok},exports.cont=function(){reset();var ok=!0;return closeStream=!1,out=new ByteArray,started=ok},function(){var len=pixels.length,nPix=len/3;indexedPixels=[];var nq=new NeuQuant(pixels,len,sample);colorTab=nq.process();for(var k=0,j=0;nPix>j;j++){var index=nq.map(255&pixels[k++],255&pixels[k++],255&pixels[k++]);usedEntry[index]=!0,indexedPixels[j]=index}pixels=null,colorDepth=8,palSize=7,null!==transparent&&(transIndex=findClosest(transparent))}),findClosest=function(c){if(null===colorTab)return-1;for(var r=(16711680&c)>>16,g=(65280&c)>>8,b=255&c,minpos=0,dmin=16777216,len=colorTab.length,i=0;len>i;){var dr=r-(255&colorTab[i++]),dg=g-(255&colorTab[i++]),db=b-(255&colorTab[i]),d=dr*dr+dg*dg+db*db,index=i/3;usedEntry[index]&&dmin>d&&(dmin=d,minpos=index),i++}return minpos},getImagePixels=function(){var w=width,h=height;pixels=[];for(var data=image,count=0,i=0;h>i;i++)for(var j=0;w>j;j++){var b=i*w*4+4*j;pixels[count++]=data[b],pixels[count++]=data[b+1],pixels[count++]=data[b+2]}},writeGraphicCtrlExt=function(){out.writeByte(33),out.writeByte(249),out.writeByte(4);var transp,disp;null===transparent?(transp=0,disp=0):(transp=1,disp=2),dispose>=0&&(disp=7&dispose),disp<<=2,out.writeByte(0|disp|0|transp),WriteShort(delay),out.writeByte(transIndex),out.writeByte(0)},writeCommentExt=function(){out.writeByte(33),out.writeByte(254),out.writeByte(comment.length),out.writeUTFBytes(comment),out.writeByte(0)},writeImageDesc=function(){out.writeByte(44),WriteShort(0),WriteShort(0),WriteShort(width),WriteShort(height),out.writeByte(firstFrame?0:128|palSize)},writeLSD=function(){WriteShort(width),WriteShort(height),out.writeByte(240|palSize),out.writeByte(0),out.writeByte(0)},writeNetscapeExt=function(){out.writeByte(33),out.writeByte(255),out.writeByte(11),out.writeUTFBytes("NETSCAPE2.0"),out.writeByte(3),out.writeByte(1),WriteShort(repeat),out.writeByte(0)},writePalette=function(){out.writeBytes(colorTab);for(var n=768-colorTab.length,i=0;n>i;i++)out.writeByte(0)},WriteShort=function(pValue){out.writeByte(255&pValue),out.writeByte(pValue>>8&255)},writePixels=function(){var myencoder=new LZWEncoder(width,height,indexedPixels,colorDepth);myencoder.encode(out)};exports.stream=function(){return out},exports.setProperties=function(has_start,is_first){started=has_start,firstFrame=is_first}}return exports},LZWEncoder=function(){var imgW,imgH,pixAry,initCodeSize,remaining,curPixel,n_bits,maxcode,g_init_bits,ClearCode,EOFCode,a_count,exports={},EOF=-1,BITS=12,HSIZE=5003,maxbits=BITS,maxmaxcode=1<<BITS,htab=[],codetab=[],hsize=HSIZE,free_ent=0,clear_flg=!1,cur_accum=0,cur_bits=0,masks=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],accum=[],LZWEncoder=exports.LZWEncoder=function(width,height,pixels,color_depth){imgW=width,imgH=height,pixAry=pixels,initCodeSize=Math.max(2,color_depth)},char_out=function(c,outs){accum[a_count++]=c,a_count>=254&&flush_char(outs)},cl_block=function(outs){cl_hash(hsize),free_ent=ClearCode+2,clear_flg=!0,output(ClearCode,outs)},cl_hash=function(hsize){for(var i=0;hsize>i;++i)htab[i]=-1},compress=exports.compress=function(init_bits,outs){var fcode,i,c,ent,disp,hsize_reg,hshift;for(g_init_bits=init_bits,clear_flg=!1,n_bits=g_init_bits,maxcode=MAXCODE(n_bits),ClearCode=1<<init_bits-1,EOFCode=ClearCode+1,free_ent=ClearCode+2,a_count=0,ent=nextPixel(),hshift=0,fcode=hsize;65536>fcode;fcode*=2)++hshift;hshift=8-hshift,hsize_reg=hsize,cl_hash(hsize_reg),output(ClearCode,outs);outer_loop:for(;(c=nextPixel())!=EOF;)if(fcode=(c<<maxbits)+ent,i=c<<hshift^ent,htab[i]!=fcode){if(htab[i]>=0){disp=hsize_reg-i,0===i&&(disp=1);do if((i-=disp)<0&&(i+=hsize_reg),htab[i]==fcode){ent=codetab[i];continue outer_loop}while(htab[i]>=0)}output(ent,outs),ent=c,maxmaxcode>free_ent?(codetab[i]=free_ent++,htab[i]=fcode):cl_block(outs)}else ent=codetab[i];output(ent,outs),output(EOFCode,outs)},flush_char=(exports.encode=function(os){os.writeByte(initCodeSize),remaining=imgW*imgH,curPixel=0,compress(initCodeSize+1,os),os.writeByte(0)},function(outs){a_count>0&&(outs.writeByte(a_count),outs.writeBytes(accum,0,a_count),a_count=0)}),MAXCODE=function(n_bits){return(1<<n_bits)-1},nextPixel=function(){if(0===remaining)return EOF;--remaining;var pix=pixAry[curPixel++];return 255&pix},output=function(code,outs){for(cur_accum&=masks[cur_bits],cur_bits>0?cur_accum|=code<<cur_bits:cur_accum=code,cur_bits+=n_bits;cur_bits>=8;)char_out(255&cur_accum,outs),cur_accum>>=8,cur_bits-=8;if((free_ent>maxcode||clear_flg)&&(clear_flg?(maxcode=MAXCODE(n_bits=g_init_bits),clear_flg=!1):(++n_bits,maxcode=n_bits==maxbits?maxmaxcode:MAXCODE(n_bits))),code==EOFCode){for(;cur_bits>0;)char_out(255&cur_accum,outs),cur_accum>>=8,cur_bits-=8;flush_char(outs)}};return LZWEncoder.apply(this,arguments),exports},NeuQuant=function(){var alphadec,thepicture,lengthcount,samplefac,network,exports={},netsize=256,prime1=499,prime2=491,prime3=487,prime4=503,minpicturebytes=3*prime4,maxnetpos=netsize-1,netbiasshift=4,ncycles=100,intbiasshift=16,intbias=1<<intbiasshift,gammashift=10,betashift=10,beta=intbias>>betashift,betagamma=intbias<<gammashift-betashift,initrad=netsize>>3,radiusbiasshift=6,radiusbias=1<<radiusbiasshift,initradius=initrad*radiusbias,radiusdec=30,alphabiasshift=10,initalpha=1<<alphabiasshift,radbiasshift=8,radbias=1<<radbiasshift,alpharadbshift=alphabiasshift+radbiasshift,alpharadbias=1<<alpharadbshift,netindex=[],bias=[],freq=[],radpower=[],NeuQuant=exports.NeuQuant=function(thepic,len,sample){var i,p;for(thepicture=thepic,lengthcount=len,samplefac=sample,network=new Array(netsize),i=0;netsize>i;i++)network[i]=new Array(4),p=network[i],p[0]=p[1]=p[2]=(i<<netbiasshift+8)/netsize,freq[i]=intbias/netsize,bias[i]=0},colorMap=function(){for(var map=[],index=new Array(netsize),i=0;netsize>i;i++)index[network[i][3]]=i;for(var k=0,l=0;netsize>l;l++){var j=index[l];map[k++]=network[j][0],map[k++]=network[j][1],map[k++]=network[j][2]}return map},inxbuild=function(){var i,j,smallpos,smallval,p,q,previouscol,startpos;for(previouscol=0,startpos=0,i=0;netsize>i;i++){for(p=network[i],smallpos=i,smallval=p[1],j=i+1;netsize>j;j++)q=network[j],q[1]<smallval&&(smallpos=j,smallval=q[1]);if(q=network[smallpos],i!=smallpos&&(j=q[0],q[0]=p[0],p[0]=j,j=q[1],q[1]=p[1],p[1]=j,j=q[2],q[2]=p[2],p[2]=j,j=q[3],q[3]=p[3],p[3]=j),smallval!=previouscol){for(netindex[previouscol]=startpos+i>>1,j=previouscol+1;smallval>j;j++)netindex[j]=i;previouscol=smallval,startpos=i}}for(netindex[previouscol]=startpos+maxnetpos>>1,j=previouscol+1;256>j;j++)netindex[j]=maxnetpos},learn=function(){var i,j,b,g,r,radius,rad,alpha,step,delta,samplepixels,p,pix,lim;for(minpicturebytes>lengthcount&&(samplefac=1),alphadec=30+(samplefac-1)/3,p=thepicture,pix=0,lim=lengthcount,samplepixels=lengthcount/(3*samplefac),delta=samplepixels/ncycles|0,alpha=initalpha,radius=initradius,rad=radius>>radiusbiasshift,1>=rad&&(rad=0),i=0;rad>i;i++)radpower[i]=alpha*((rad*rad-i*i)*radbias/(rad*rad));for(step=minpicturebytes>lengthcount?3:lengthcount%prime1!==0?3*prime1:lengthcount%prime2!==0?3*prime2:lengthcount%prime3!==0?3*prime3:3*prime4,i=0;samplepixels>i;)if(b=(255&p[pix+0])<<netbiasshift,g=(255&p[pix+1])<<netbiasshift,r=(255&p[pix+2])<<netbiasshift,j=contest(b,g,r),altersingle(alpha,j,b,g,r),0!==rad&&alterneigh(rad,j,b,g,r),pix+=step,pix>=lim&&(pix-=lengthcount),i++,0===delta&&(delta=1),i%delta===0)for(alpha-=alpha/alphadec,radius-=radius/radiusdec,rad=radius>>radiusbiasshift,1>=rad&&(rad=0),j=0;rad>j;j++)radpower[j]=alpha*((rad*rad-j*j)*radbias/(rad*rad))},unbiasnet=(exports.map=function(b,g,r){var i,j,dist,a,bestd,p,best;for(bestd=1e3,best=-1,i=netindex[g],j=i-1;netsize>i||j>=0;)netsize>i&&(p=network[i],dist=p[1]-g,dist>=bestd?i=netsize:(i++,0>dist&&(dist=-dist),a=p[0]-b,0>a&&(a=-a),dist+=a,bestd>dist&&(a=p[2]-r,0>a&&(a=-a),dist+=a,bestd>dist&&(bestd=dist,best=p[3])))),j>=0&&(p=network[j],dist=g-p[1],dist>=bestd?j=-1:(j--,0>dist&&(dist=-dist),a=p[0]-b,0>a&&(a=-a),dist+=a,bestd>dist&&(a=p[2]-r,0>a&&(a=-a),dist+=a,bestd>dist&&(bestd=dist,best=p[3]))));return best},exports.process=function(){return learn(),unbiasnet(),inxbuild(),colorMap()},function(){var i;for(i=0;netsize>i;i++)network[i][0]>>=netbiasshift,network[i][1]>>=netbiasshift,network[i][2]>>=netbiasshift,network[i][3]=i}),alterneigh=function(rad,i,b,g,r){var j,k,lo,hi,a,m,p;for(lo=i-rad,-1>lo&&(lo=-1),hi=i+rad,hi>netsize&&(hi=netsize),j=i+1,k=i-1,m=1;hi>j||k>lo;){if(a=radpower[m++],hi>j){p=network[j++];try{p[0]-=a*(p[0]-b)/alpharadbias,p[1]-=a*(p[1]-g)/alpharadbias,p[2]-=a*(p[2]-r)/alpharadbias}catch(e){}}if(k>lo){p=network[k--];try{p[0]-=a*(p[0]-b)/alpharadbias,p[1]-=a*(p[1]-g)/alpharadbias,p[2]-=a*(p[2]-r)/alpharadbias}catch(e){}}}},altersingle=function(alpha,i,b,g,r){var n=network[i];n[0]-=alpha*(n[0]-b)/initalpha,n[1]-=alpha*(n[1]-g)/initalpha,n[2]-=alpha*(n[2]-r)/initalpha},contest=function(b,g,r){var i,dist,a,biasdist,betafreq,bestpos,bestbiaspos,bestd,bestbiasd,n;for(bestd=~(1<<31),bestbiasd=bestd,bestpos=-1,bestbiaspos=bestpos,i=0;netsize>i;i++)n=network[i],dist=n[0]-b,0>dist&&(dist=-dist),a=n[1]-g,0>a&&(a=-a),dist+=a,a=n[2]-r,0>a&&(a=-a),dist+=a,bestd>dist&&(bestd=dist,bestpos=i),biasdist=dist-(bias[i]>>intbiasshift-netbiasshift),bestbiasd>biasdist&&(bestbiasd=biasdist,bestbiaspos=i),betafreq=freq[i]>>betashift,freq[i]-=betafreq,bias[i]+=betafreq<<gammashift;return freq[bestpos]+=beta,bias[bestpos]-=betagamma,bestbiaspos};return NeuQuant.apply(this,arguments),exports};